<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resemblyzer Voice Security Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 1.1em;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .card h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .input-group input,
        .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .status {
            padding: 12px;
            border-radius: 6px;
            margin-top: 15px;
            font-weight: 500;
        }
        
        .status-success {
            background: #d1fae5;
            color: #065f46;
            border: 2px solid #10b981;
        }
        
        .status-error {
            background: #fee2e2;
            color: #991b1b;
            border: 2px solid #ef4444;
        }
        
        .status-info {
            background: #dbeafe;
            color: #1e40af;
            border: 2px solid #3b82f6;
        }
        
        .recording-pulse {
            display: inline-block;
            width: 10px;
            height: 10px;
            background: #ef4444;
            border-radius: 50%;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .speaker-list {
            margin-top: 15px;
        }
        
        .speaker-item {
            padding: 12px;
            background: #f9fafb;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .speaker-item:hover {
            background: #f3f4f6;
        }
        
        .speaker-item.selected {
            background: #dbeafe;
            border-color: #3b82f6;
        }
        
        .result {
            margin-top: 15px;
            padding: 20px;
            border-radius: 8px;
            font-size: 18px;
        }
        
        .result-verified {
            background: #d1fae5;
            border: 3px solid #10b981;
        }
        
        .result-rejected {
            background: #fee2e2;
            border: 3px solid #ef4444;
        }
        
        .confidence {
            font-size: 36px;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
        }
        
        .matches {
            margin-top: 15px;
        }
        
        .match-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f9fafb;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        
        .progress-bar {
            width: 150px;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #667eea;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéôÔ∏è Resemblyzer Voice Security Demo</h1>
            <p>Real-time speaker verification & identification using deep learning</p>
        </div>
        
        <div class="grid">
            <!-- Recording Panel -->
            <div class="card">
                <h2>üé§ Record Audio</h2>
                <div class="input-group">
                    <label>Duration</label>
                    <select id="duration">
                        <option value="3">3 seconds</option>
                        <option value="5" selected>5 seconds</option>
                        <option value="10">10 seconds</option>
                    </select>
                </div>
                <button class="btn btn-primary" id="recordBtn" onclick="startRecording()">
                    <span>üé§</span> Start Recording
                </button>
                <div id="recordStatus"></div>
            </div>
            
            <!-- Registration Panel -->
            <div class="card">
                <h2>üë§ Quick Register</h2>
                <div class="input-group">
                    <label>Speaker ID</label>
                    <input type="text" id="speakerId" placeholder="e.g., john_doe">
                </div>
                <div class="input-group">
                    <label>Name</label>
                    <input type="text" id="speakerName" placeholder="e.g., John Doe">
                </div>
                <button class="btn btn-success" id="registerBtn" onclick="registerSpeaker()" disabled>
                    <span>‚úÖ</span> Register Speaker
                </button>
                <div id="registerStatus"></div>
            </div>
            
            <!-- Verification Panel -->
            <div class="card">
                <h2>üîç Verify (1:1)</h2>
                <div class="input-group">
                    <label>Select Speaker</label>
                    <select id="speakerSelect">
                        <option value="">-- Select --</option>
                    </select>
                </div>
                <button class="btn btn-primary" id="verifyBtn" onclick="verifySpeaker()" disabled>
                    <span>‚úì</span> Verify Identity
                </button>
                <div id="verifyResult"></div>
            </div>
            
            <!-- Identification Panel -->
            <div class="card">
                <h2>üéØ Identify (1:N)</h2>
                <button class="btn btn-primary" id="identifyBtn" onclick="identifySpeaker()" disabled>
                    <span>üîé</span> Identify Speaker
                </button>
                <div id="identifyResult"></div>
            </div>
        </div>
        
        <!-- Speaker Gallery -->
        <div class="card">
            <h2>üë• Registered Speakers (<span id="speakerCount">0</span>)</h2>
            <div class="speaker-list" id="speakerList"></div>
        </div>
    </div>
    
    <script>
        const API_URL = 'http://localhost:5001/api';
        let recordedAudio = null;
        let mediaRecorder = null;
        let audioChunks = [];
        
        // Load speakers on page load
        window.addEventListener('load', loadSpeakers);
        
        async function loadSpeakers() {
            try {
                const response = await fetch(`${API_URL}/speakers`);
                const data = await response.json();
                
                if (data.success) {
                    const speakers = data.data;
                    document.getElementById('speakerCount').textContent = speakers.length;
                    
                    // Update speaker select
                    const select = document.getElementById('speakerSelect');
                    select.innerHTML = '<option value="">-- Select --</option>';
                    speakers.forEach(speaker => {
                        const option = document.createElement('option');
                        option.value = speaker.id;
                        option.textContent = `${speaker.name} (${speaker.id})`;
                        select.appendChild(option);
                    });
                    
                    // Update speaker list
                    const list = document.getElementById('speakerList');
                    if (speakers.length === 0) {
                        list.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No speakers registered yet</p>';
                    } else {
                        list.innerHTML = speakers.map(speaker => `
                            <div class="speaker-item">
                                <strong>${speaker.name}</strong><br>
                                <small style="color: #666;">${speaker.id}</small>
                            </div>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('Error loading speakers:', error);
            }
        }
        
        async function startRecording() {
            const duration = parseInt(document.getElementById('duration').value) * 1000;
            const btn = document.getElementById('recordBtn');
            const status = document.getElementById('recordStatus');
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        recordedAudio = reader.result.split(',')[1]; // base64
                        status.innerHTML = '<div class="status status-success">‚úÖ Recording completed!</div>';
                        enableButtons();
                    };
                    reader.readAsDataURL(audioBlob);
                    stream.getTracks().forEach(track => track.stop());
                };
                
                mediaRecorder.start();
                btn.disabled = true;
                btn.classList.add('btn-danger');
                btn.innerHTML = '<span class="recording-pulse"></span> Recording...';
                status.innerHTML = `<div class="status status-info">üéôÔ∏è Recording for ${duration/1000} seconds...</div>`;
                
                setTimeout(() => {
                    mediaRecorder.stop();
                    btn.disabled = false;
                    btn.classList.remove('btn-danger');
                    btn.innerHTML = '<span>üé§</span> Start Recording';
                }, duration);
                
            } catch (error) {
                status.innerHTML = '<div class="status status-error">‚ùå Microphone access denied</div>';
                console.error('Recording error:', error);
            }
        }
        
        function enableButtons() {
            document.getElementById('registerBtn').disabled = false;
            document.getElementById('verifyBtn').disabled = false;
            document.getElementById('identifyBtn').disabled = false;
        }
        
        async function registerSpeaker() {
            const speakerId = document.getElementById('speakerId').value.trim();
            const speakerName = document.getElementById('speakerName').value.trim();
            const status = document.getElementById('registerStatus');
            
            if (!speakerId || !speakerName) {
                status.innerHTML = '<div class="status status-error">‚ùå Please fill in all fields</div>';
                return;
            }
            
            if (!recordedAudio) {
                status.innerHTML = '<div class="status status-error">‚ùå Please record audio first</div>';
                return;
            }
            
            status.innerHTML = '<div class="status status-info">‚è≥ Registering...</div>';
            
            try {
                const response = await fetch(`${API_URL}/speakers`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        speaker_id: speakerId,
                        name: speakerName,
                        audio_files: [{
                            name: `${speakerId}.wav`,
                            data: recordedAudio
                        }]
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    status.innerHTML = `<div class="status status-success">‚úÖ ${speakerName} registered successfully!</div>`;
                    document.getElementById('speakerId').value = '';
                    document.getElementById('speakerName').value = '';
                    loadSpeakers();
                } else {
                    status.innerHTML = `<div class="status status-error">‚ùå ${data.error}</div>`;
                }
            } catch (error) {
                status.innerHTML = '<div class="status status-error">‚ùå Registration failed</div>';
                console.error(error);
            }
        }
        
        async function verifySpeaker() {
            const speakerId = document.getElementById('speakerSelect').value;
            const result = document.getElementById('verifyResult');
            
            if (!speakerId) {
                result.innerHTML = '<div class="status status-error">‚ùå Please select a speaker</div>';
                return;
            }
            
            if (!recordedAudio) {
                result.innerHTML = '<div class="status status-error">‚ùå Please record audio first</div>';
                return;
            }
            
            result.innerHTML = '<div class="status status-info">‚è≥ Verifying...</div>';
            
            try {
                const response = await fetch(`${API_URL}/verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        expected_speaker: speakerId,
                        audio_data: recordedAudio,
                        threshold: 0.75
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const verified = data.data.access_granted;
                    const confidence = (data.data.confidence * 100).toFixed(1);
                    
                    result.innerHTML = `
                        <div class="result ${verified ? 'result-verified' : 'result-rejected'}">
                            <div style="font-size: 24px; font-weight: bold;">
                                ${verified ? '‚úÖ VERIFIED' : '‚ùå REJECTED'}
                            </div>
                            <div class="confidence">${confidence}%</div>
                            <div>Speaker: ${data.data.speaker_name}</div>
                            <div>Threshold: ${(data.data.threshold * 100).toFixed(0)}%</div>
                        </div>
                    `;
                } else {
                    result.innerHTML = `<div class="status status-error">‚ùå ${data.error}</div>`;
                }
            } catch (error) {
                result.innerHTML = '<div class="status status-error">‚ùå Verification failed</div>';
                console.error(error);
            }
        }
        
        async function identifySpeaker() {
            const result = document.getElementById('identifyResult');
            
            if (!recordedAudio) {
                result.innerHTML = '<div class="status status-error">‚ùå Please record audio first</div>';
                return;
            }
            
            result.innerHTML = '<div class="status status-info">‚è≥ Identifying...</div>';
            
            try {
                const response = await fetch(`${API_URL}/identify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        audio_data: recordedAudio,
                        top_k: 5,
                        threshold: 0.70
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const best = data.data.best_match;
                    const matches = data.data.top_matches;
                    
                    let html = '';
                    if (best) {
                        html += `
                            <div class="result result-verified">
                                <div style="font-size: 24px; font-weight: bold;">üéØ IDENTIFIED</div>
                                <div class="confidence">${(best.confidence * 100).toFixed(1)}%</div>
                                <div style="font-size: 20px;">${best.name}</div>
                            </div>
                        `;
                    } else {
                        html += '<div class="status status-error">‚ùå No match found</div>';
                    }
                    
                    html += '<div class="matches"><strong>Top Matches:</strong>';
                    matches.forEach((match, i) => {
                        const conf = (match.confidence * 100).toFixed(1);
                        html += `
                            <div class="match-item">
                                <span><strong>#${i+1}</strong> ${match.name}</span>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${conf}%"></div>
                                    </div>
                                    <span style="font-weight: bold;">${conf}%</span>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    
                    result.innerHTML = html;
                } else {
                    result.innerHTML = `<div class="status status-error">‚ùå ${data.error}</div>`;
                }
            } catch (error) {
                result.innerHTML = '<div class="status status-error">‚ùå Identification failed</div>';
                console.error(error);
            }
        }
    </script>
</body>
</html>
